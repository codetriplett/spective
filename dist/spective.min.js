//spective@v3.0.0
(()=>{var W=Object.defineProperty;var Y=(n,t,e)=>t in n?W(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var T=(n,t,e)=>(Y(n,typeof t!="symbol"?t+"":t,e),e);function $(n){let t=n.slice(1).split("#"),e=[];for(let s of t){let i=s.split("");if(i.length<6){let[r,a,c]=i.splice(0,3);i.unshift(r,r,a,a,c,c)}let o=i.length%3;o===1?i.push(i[i.length-1]):o||i.push("f","f");for(let r of[0,2,4,6]){let a=parseInt(i[r],16),c=parseInt(i[r+1],16);e.push((a<<4)+c)}}return new Uint8Array(e)}function K(n,t=1,e=1,s=1,i=1){return n.map(([o,r])=>{let a=o/s,c=r/i,f=(o+t)/s,d=(r+e)/i;return[a,d,f,d,f,c,f,c,a,c,a,d]})}var I=class{constructor(t={}){this.texture=void 0,this.nodes=new Set,this.update(Object.assign(I.defaultProps,t))}update(t={}){let{texture:e}=Object.assign(this,t);if(typeof e=="string")if(e.startsWith("#")){let s=$(e);this._texture=s,this._finalizeUpdate(t)}else{let s=new window.Image;s.src=e,this._texture=void 0,s.addEventListener("load",()=>{this.texture===e&&(this._texture=s,this._finalizeUpdate(t))});return}this._finalizeUpdate(t)}_finalizeUpdate(t){let{nodes:e,tags:s,cells:i,sx:o,sy:r,_texture:a}=this,c=!1;if("tags"in t&&s===t.tags){let{tags:f}=t,d=f.trim();this._tags=d?d.split(/\s+/):[]}if("cells"in t&&i===t.cells){let{cells:f}=t;this._cells=f?f.split(" ").map(d=>d.split(":").map(l=>Number(l))):[]}if("texture"in t||a&&"cells"in t){let f=a instanceof Uint8Array,d=f?a.length>>2:a?.width,l=f?1:a?.height;"sx"in this||(this.sx=o=d),"sy"in this||(this.sy=r=l),this._coordinates=K(this._cells,o,r,d,l),c=!0}if("ox"in t||"oy"in t)for(let f of e)f._origin=void 0;if("sx"in t||"sy"in t||c)for(let f of e)f._scale=void 0}add(t={}){return t instanceof w||(t=new w(t)),t.asset?.remove?.(t),t.asset=this,Object.assign(t,{_origin:void 0,_scale:void 0}),this.nodes.add(t),t}remove(t){t.asset=void 0,this.nodes.delete(t)}destroy(t){let{geometry:e,nodes:s}=this;e&&e!==t&&e.remove(this);for(let i of s)i.destroy(this)}},v=I;T(v,"defaultProps",{tags:"",cells:"0:0"});function N(...n){return n.reduce((t,e)=>[t[0]+e[0],t[1]+e[1]])}function R(...n){return n.reduce((t,e)=>{let s=[];for(let i=0;i<t.length;i+=2)s.push(t[i]*e[0]+t[i+1]*e[1],t[i]*e[2]+t[i+1]*e[3]);return s})}var J=[[0,0],[1,0],[1,1],[0,1]],D=class{constructor(t){Object.assign(this,D.defaultProps),this.nodes=new Set,t&&this.update(t)}update(t={}){"asset"in t&&(this.asset?.remove?.(this),t.asset.add(this)),"group"in t&&(this.group?.remove?.(this),t.group.add(this));let{oncollide:e,collisions:s}=Object.assign(this,t);if("tags"in t){let{tags:i}=t,o=i.trim();this._tags=o?o.split(/\s+/):[]}"oncollide"in t&&(e?s||(this.collisions=new Set):this.collisions=void 0),this._finalizeUpdate(t)}_finalizeUpdate(t){if(("ox"in t||"oy"in t)&&(this._origin=void 0),("px"in t||"py"in t)&&(this._position=void 0),"az"in t&&(this._rotation=void 0),("sx"in t||"sy"in t)&&(this._scale=void 0),"oxa"in t||"oya"in t||"pxa"in t||"pya"in t||"aza"in t||"sxa"in t||"sya"in t){let{oxa:e,oya:s,pxa:i,pya:o,aza:r,sxa:a,sya:c}=this;this._aActive=!!(e||s||i||o||r||a||c)}if("oxs"in t||"oys"in t||"pxs"in t||"pys"in t||"azs"in t||"sxs"in t||"sys"in t){let{oxs:e,oys:s,pxs:i,pys:o,azs:r,sxs:a,sys:c}=this;this._sActive=!!(e||s||i||o||r||a||c)}}add(t={}){return t instanceof D||(t=new D(t)),t.group?.remove?.(t),t.group=this,this.nodes.add(t),t}remove(t){t.group=void 0,this.nodes.delete(t)}destroy(t){let{group:e,asset:s,nodes:i}=this;e&&e!==t&&e.remove(this),s&&s!==t&&s.remove(this);for(let o of i)o.destroy(this)}find(t,e){let{nodes:s}=this,i=[];if(typeof t=="string"){let o=t.split(",").map(r=>r.trim().split(/\s+/).map(a=>a.split(".")));return this._findFromQueries(o,e)}else{if(typeof t!="function")return i;t(this)&&(i.push(this),e-=1)}for(let o of s){if(e<=0)break;let r=o.find(t,e);i.push(...r),e-=r.length}return i}_findFromQueries(t,e){let s=[],{_tags:i=[],asset:o,nodes:r}=this,a=o?[...o._tags,...i]:i,c=o?.type||"",f=[],d=!1;for(let[l,...x]of t){let[h,...u]=l;h!==c||!u.every(m=>a.some(A=>A===m))||(x.length?f.push(x):d=!0)}d&&(s.push(this),e-=1),f.push(...t);for(let l of r){if(e<=0)break;let x=l._findFromQueries(f,e);s.push(...x),e-=x.length}return s}paint(t={}){t instanceof v||(t=new v(t));let{asset:e}=this;return e&&e.nodes.delete(this),t.add(this),t}_applyPhysics(t,e){let{group:s,_lastPhysicsFrame:i}=this;if(i===e)return;s&&s._applyPhysics(t,e),this._lastPhysicsFrame=e;let{_aActive:o,_sActive:r,oxs:a,oys:c,pxs:f,pys:d,azs:l,sxs:x,sys:h}=this,u={};if(o){let{oxa:_,oya:S,pxa:P,pya:C,aza:U,sxa:F,sya:j}=this;_&&(u.oxs=a+=_*t),S&&(u.oys=c+=S*t),P&&(u.pxs=f+=P*t),C&&(u.pys=d+=C*t),U&&(u.azs=l+=U*t),F&&(u.sxs=x+=F*t),j&&(u.sys=h+=j*t)}else if(!r)return;let{ox:p,oy:m,px:A,py:O,az:E,sx:y,sy:g}=this;a&&(u.ox=p+a*t),c&&(u.oy=m+c*t),f&&(u.px=A+f*t),d&&(u.py=O+d*t),l&&(u.az=E+l*t),x&&(u.sx=y+x*t),h&&(u.sy=g+h*t),this.update(u)}_recalculate(t,e){let{group:s}=this;s&&s._recalculate(t,this);let{asset:i,nodes:o,_composite:r,_position:a,_origin:c,_rotation:f,_scale:d,_inverted:l}=this;if(r&&a&&c&&f&&d)return;if(this._lastCalculatedFrame=t,!f||!d){if(!f){let{az:h}=this,u=Math.cos(h),p=Math.sin(h);this._rotation=[u,-p,p,u]}if(!d){let{sx:h,sy:u}=this;i&&(h*=i.sx||1,u*=i.sy||1),this._scale=l?[1/h,0,0,1/u]:[h,0,0,u]}({_rotation:f,_scale:d}=this),this._matrix=l?R(d,f):R(f,d),c=void 0}let{_matrix:x}=this;if(this._composite=s?R(s._composite,x):x,!a||!r){let{px:h,py:u}=this,p=l?[-h,-u]:[h,u];s&&(p=R(p,s._composite),p=N(p,s._position)),this._position=p}if(!c||!r){let{ox:h,oy:u,_composite:p}=this;i&&(h+=i.ox||0,u+=i.oy||0),this._origin=R(l?[h,u]:[-h,-u],p)}for(let h of o)h._composite=void 0,h!==e&&h._recalculate(t,this)}_recalculateBoundaries(){let{_composite:t,_position:e,_origin:s,_boundaries:i}=this,o=J.map(x=>{let h=R(x,t);return N(h,e,s)}),r=o.map(x=>x[0]),a=o.map(x=>x[1]),c=Math.min(...r),f=Math.max(...r),d=Math.min(...a),l=Math.max(...a);this._boundaries=[c,f,d,l]}},w=D;T(w,"defaultProps",{ox:0,oy:0,px:0,py:0,az:0,sx:1,sy:1,oxs:0,oys:0,oxa:0,oya:0,pxs:0,pys:0,pxa:0,pya:0,azs:0,aza:0,sxs:0,sys:0,sxa:0,sya:0,cell:0});var Z=[0,0,0,1,0,0,1,1,0,1,1,0,0,1,0,0,0,0],V=class{constructor(t={}){this.joints=Object.assign(new v,{geometry:this}),this.assets=new Set,this.update({...V.defaultProps,...t})}update(t={}){Object.assign(this,t),"mesh"in t&&(this._mesh=t.mesh)}add(t={}){if("texture"in t)t instanceof v||(t=new v(t));else{let e=this.joints.add(t);return e._recalculate(0),e}return t.geometry?.remove?.(t),t.geometry=this,this.assets.add(t),t}remove(t){this.assets.delete(t)}destroy(t){let{layer:e,assets:s}=this;e&&e!==t&&e.remove(this);for(let i of s)i.destroy(this)}},L=V;T(L,"defaultProps",{mesh:Z});var k=class{constructor(t={}){this.library=Object.assign(new L,{layer:this}),this.geometries=new Set,this.update({...k.defaultProps,...t})}update(t={}){Object.assign(this,t)}add(t={}){if("mesh"in t)t instanceof L||(t=new L(t));else return this.library.add(t);return t.layer?.remove?.(t),t.layer=this,this.geometries.add(t),t}remove(t){this.geometries.delete(t)}destroy(t){let{scene:e,geometries:s}=this;e&&e!==t&&e.remove(this);for(let i of s)i.destroy(this)}},b=k;T(b,"defaultProps",{parallax:1});var tt=`
	attribute vec3 aVertex;
	attribute vec2 aCoordinate;

	uniform mat2 uMatrix;
	uniform vec2 uPosition;
	uniform vec2 uOrigin;
	uniform float uLayerParallax;
	uniform float uLayerSquash;
	uniform float uLayerDepth;
	uniform mat2 uSceneMatrix;
	uniform vec2 uScenePosition;
	uniform vec2 uSceneOrigin;

	varying vec2 vCoordinate;

	void main() {
		vec2 sceneShift = (uScenePosition + uSceneOrigin) * uLayerParallax;
		vec2 vertex = aVertex.xy * uMatrix + uPosition + uOrigin + sceneShift;
		float depth = aVertex.z * uLayerSquash + uLayerDepth;
		gl_Position = vec4(vertex * uSceneMatrix, -depth, 1.0);
		vCoordinate = aCoordinate;
	}
`,et=`
	precision mediump float;

	uniform sampler2D uImage;

	varying vec2 vCoordinate;

	void main() {
		vec4 pixel = texture2D(uImage, vCoordinate);
		gl_FragColor = pixel;
	}
`;function H(n,t,e){let s=n.createShader(e);return n.shaderSource(s,t),n.compileShader(s),n.getShaderParameter(s,n.COMPILE_STATUS)||(console.log(`Error compiling ${e===n.VERTEX_SHADER?"vertex":"fragment"} shader:`),console.log(n.getShaderInfoLog(s))),s}function G(n){let t=n.createProgram(),e=H(n,tt,n.VERTEX_SHADER);e&&n.attachShader(t,e);let s=H(n,et,n.FRAGMENT_SHADER);return s&&n.attachShader(t,s),n.linkProgram(t),n.getProgramParameter(t,n.LINK_STATUS)||(console.log("Error linking shader program:"),console.log(n.getProgramInfoLog(t))),t}function q(n,t,e,s,i){let{ARRAY_BUFFER:o,STATIC_DRAW:r,FLOAT:a}=n;n.bindBuffer(o,e),n.enableVertexAttribArray(t),n.bufferData(o,new Float32Array(i),r),n.vertexAttribPointer(t,s,a,!1,0,0)}function Q(n,t,e,s){let i=[];for(let o of n){let{_lastCalculatedFrame:r,_boundaries:a}=o;if(r!==e){i.push(o);continue}for(let c of t){if(c===o)continue;let{_boundaries:f}=o,{_boundaries:d}=c,l=[d[1]-f[0],f[1]-d[0],d[3]-f[2],f[3]-d[2]],x=l.every(y=>y>=0);if(s){let[y,g,_,S]=l;l=[g,y,S,_];let P=o;o=c,c=P}let{collisions:h,oncollide:u}=o;if(x===h.has(c))continue;let p=Math.min(...l),m=l.indexOf(p),{param:A}=c,E=u({overlap:l,side:m,param:A,action:x?"collide":"separate",self:o,node:c});if(E){let y=m%2?-1:1,g={...E};m<2&&!("px"in g)?g.px=o.px+l[m]*y:m>1&&!("py"in g)&&(g.py=o.py+l[m]*y),o.update(g)}else x?h.add(c):h.delete(c)}}return i}var M=class extends w{constructor(t){super(),this.ui=Object.assign(new b,{scene:this}),this.layers=[],this._inverted=!0,t&&this.update(t)}update(t={}){if(Object.assign(this,t),this._finalizeUpdate(t),!("gl"in this)){let{density:e=2,canvas:s,width:i,height:o}=this;if(!s){let{width:c=640,height:f=360}=t;s=document.createElement("canvas"),document.body.appendChild(s),Object.assign(s,{width:Math.round(c*e),height:Math.round(f*e)}),Object.assign(s.style,{position:"absolute",left:"50vw",top:"0",width:`${c/f*100}vh`,height:"100vh",transform:"translateX(-50%)"})}i===void 0&&(i=s.width/e),o===void 0&&(o=s.height/e),this.asset={ox:0,oy:0,sx:i/2,sy:o/2};let r=s.getContext("webgl"),a=G(r);r.clearColor(.5,.5,.5,.5),r.useProgram(a),this.gl=r,this.aVertex=r.getAttribLocation(a,"aVertex"),this.aCoordinate=r.getAttribLocation(a,"aCoordinate"),this.uMatrix=r.getUniformLocation(a,"uMatrix"),this.uPosition=r.getUniformLocation(a,"uPosition"),this.uOrigin=r.getUniformLocation(a,"uOrigin"),this.uLayerParallax=r.getUniformLocation(a,"uLayerParallax"),this.uLayerSquash=r.getUniformLocation(a,"uLayerSquash"),this.uLayerDepth=r.getUniformLocation(a,"uLayerDepth"),this.uSceneMatrix=r.getUniformLocation(a,"uSceneMatrix"),this.uScenePosition=r.getUniformLocation(a,"uScenePosition"),this.uSceneOrigin=r.getUniformLocation(a,"uSceneOrigin"),r.enable(r.DEPTH_TEST),r.blendEquation(r.FUNC_ADD),r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA),this._frameCount=0,setTimeout(()=>this._animate(),0),document.addEventListener("visibilitychange",()=>{document.hidden?this.pause():this.resume()})}}add(t={}){if("parallax"in t)t instanceof b||(t=new b(t));else return this.ui.add(t);let{layers:e}=this;return e.indexOf(t)===-1&&(t.scene?.remove?.(t),e.push(t)),t.scene=this,e.sort((s,i)=>s.parallax-i.parallax),t}remove(t){let{layers:e}=this,s=e.indexOf(t);s!==-1&&e.splice(s,1)}destroy(){for(let t of this.layers)t.destroy(this)}_renderGeometry(t){let{gl:e,aVertex:s,aCoordinate:i,uMatrix:o,uPosition:r,uOrigin:a}=this,{TEXTURE_2D:c,CLAMP_TO_EDGE:f,RGBA:d,TRIANGLES:l}=e;"_glBuffer"in t||(t._glBuffer=e.createBuffer());let{mesh:x,assets:h,_glBuffer:u}=t;q(e,s,u,3,x);for(let p of h){"_glTexture"in p||(p._glTexture=e.createTexture()),"_glBuffer"in p||(p._glBuffer=e.createBuffer());let{_texture:m,_coordinates:A,width:O,height:E,nodes:y,_glTexture:g,_glBuffer:_}=p;if(m===void 0)continue;let S=[];e.activeTexture(e.TEXTURE0),e.bindTexture(c,g),m instanceof Uint8Array?S=[O,E,0]:(e.texParameteri(c,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(c,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(c,e.TEXTURE_WRAP_S,f),e.texParameteri(c,e.TEXTURE_WRAP_T,f)),e.texImage2D(c,0,d,...S,d,e.UNSIGNED_BYTE,m);for(let P of y){let{cell:C,_position:U,_origin:F,_composite:j}=P;q(e,i,_,2,A[C]),e.uniformMatrix2fv(o,!1,j),e.uniform2fv(r,U),e.uniform2fv(a,F),e.drawArrays(l,0,6)}}}render(t){let{gl:e,ui:s,layers:i,_frameCount:o}=this,r=[...i,s],a=r.map(({library:y,geometries:g})=>{let _=[...y.joints.nodes];for(let{assets:S}of[y,...g])for(let{nodes:P}of S)_.push(...P);return _});this._applyPhysics(t,o);for(let y of a)for(let g of y)g._applyPhysics(t,o);this.ondraw&&this.ondraw(t,o);for(let y of a){let g=[],_=[];for(let P of y){let{param:C,oncollide:U}=P;!U&&C===void 0||(U&&g.push(P),C!==void 0&&_.push(P),P._recalculate(o),P._recalculateBoundaries(o))}let S=Q(g,_,o);Q(_,S,o,!0)}this._recalculate(o);for(let y of a)for(let g of y)g._recalculate(o);let{uSceneMatrix:c,uScenePosition:f,uSceneOrigin:d,uLayerParallax:l,uLayerSquash:x,uLayerDepth:h,_matrix:u,_position:p,_origin:m,_scale:A}=this;e.clear(e.COLOR_BUFFER_BIT),e.uniformMatrix2fv(c,!1,u),e.uniform2fv(f,p),e.uniform2fv(d,m);let O=2/r.length;e.uniform1f(x,O),e.depthMask(!0),e.disable(e.BLEND);let E=1-O/2;for(let y=r.length-1;y>=0;y--){let{parallax:g,geometries:_}=r[y];e.uniform1f(l,g),e.uniform1f(h,E),E-=O;for(let S of _)this._renderGeometry(S)}e.depthMask(!1),e.enable(e.BLEND),E=-1+O/2;for(let y of r){let{parallax:g,library:_}=y;y===s&&e.uniformMatrix2fv(c,!1,A),e.uniform1f(l,g),e.uniform1f(h,E),E+=O,this._renderGeometry(_)}this._frameCount++}_animate(t=0){this.render(t),requestAnimationFrame(e=>{if(this._paused)return;let{_previousTime:s=e}=this;this._previousTime=e;let i=(s&&e-s)/1e3;this._animate(i)})}resume(){this._paused&&(this._paused=!1,this._animate())}pause(){this._paused||(this._paused=!0,this._previousTime=void 0)}};T(M,"defaultProps",{});var z=new Set,X={};window.addEventListener("keydown",({key:n,repeat:t})=>{if(t)return;let e=X[n];e&&(z.add(e),e.activate())});window.addEventListener("keyup",({key:n})=>{let t=X[n];t&&(z.delete(t),t.deactivate())});var B=class{constructor(t,e,s){let{key:i}=t;i&&(X[i]=this),this.ondown=e,this.onup=s}activate(){this.ondown()}deactivate(){this.onup&&this.onup()}};var st={createTextNode(){},createDocumentFragment(){return{childNodes:[],appendChild(n){this.removeChild(n),this.childNodes.push(n),n.parentElement=this},insertBefore(n,t){let{childNodes:e}=this;this.removeChild(n);let s=e.indexOf(t);e.splice(s,0,n),n.parentElement=this},removeChild(n){let{childNodes:t}=this,e=t.indexOf(n);e!==-1&&(t.splice(e,1),n.parentElement=null)}}},createElement(n){n=n.toLowerCase();let t=new{scene:M,layer:b,geometry:L,asset:v,node:w}[n];return Object.assign(t,{tagName:n,childNodes:[],appendChild:e=>t.add(e),insertBefore:e=>t.add(e),removeChild:e=>e.destroy()})}};function it(n,t,e,s){if(e){e=new Set(e);let i=Object.entries(t).filter(([o,r])=>(e.delete(o),r!==n[o]&&(o.length>3||r!==void 0)));for(let o of e)i.push([o,s[o]]);if(!i.length)return;t=Object.fromEntries(i)}else{let i=t.id;i&&(!Object.prototype.hasOwnProperty.call(window,i)||window[i]._instance===n)&&(window[i]=n)}n.update(t)}var nt={scene:M.defaultProps,layer:b.defaultProps,geometry:L.defaultProps,asset:v.defaultProps,node:w.defaultProps},Bt=0,Dt=1,Ft=2,jt=3;function ot(...n){let[t={}]=n;return"key"in t?new B(...n):new M(...n)}window.spective=Object.assign(ot,{Scene:M,Layer:b,Geometry:L,Asset:v,Node:w,Control:B,controls:z,framework:[st,it,nt],LEFT:0,RIGHT:1,BOTTOM:2,TOP:3});})();
/*! For license information please see spective.min.js.LEGAL.txt */
