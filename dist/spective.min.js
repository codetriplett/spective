(()=>{var W=Object.defineProperty;var Y=(r,t,e)=>t in r?W(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var T=(r,t,e)=>(Y(r,typeof t!="symbol"?t+"":t,e),e);function $(r){let t=r.slice(1).split("#"),e=[];for(let s of t){let i=s.split("");if(i.length<6){let[o,a,c]=i.splice(0,3);i.unshift(o,o,a,a,c,c)}let n=i.length%3;n===1?i.push(i[i.length-1]):n||i.push("f","f");for(let o of[0,2,4,6]){let a=parseInt(i[o],16),c=parseInt(i[o+1],16);e.push((a<<4)+c)}}return new Uint8Array(e)}function K(r,t=1,e=1,s=1,i=1){return r.map(([n,o])=>{let a=n/s,c=o/i,f=(n+t)/s,u=(o+e)/i;return[a,u,f,u,f,c,f,c,a,c,a,u]})}var I=class{constructor(t={}){this.texture=void 0,this.nodes=new Set,this.update(Object.assign(I.defaultProps,t))}update(t={}){let{texture:e}=Object.assign(this,t);if(typeof e=="string")if(e.startsWith("#")){let s=$(e);this._texture=s,this._finalizeUpdate(t)}else{let s=new window.Image;s.src=e,this._texture=void 0,s.addEventListener("load",()=>{this.texture===e&&(this._texture=s,this._finalizeUpdate(t))});return}this._finalizeUpdate(t)}_finalizeUpdate(t){let{nodes:e,tags:s,cells:i,sx:n,sy:o,_texture:a}=this,c=!1;if("tags"in t&&s===t.tags){let{tags:f}=t,u=f.trim();this._tags=u?u.split(/\s+/):[]}if("cells"in t&&i===t.cells){let{cells:f}=t;this._cells=f?f.split(" ").map(u=>u.split(":").map(l=>Number(l))):[]}if("texture"in t||a&&"cells"in t){let f=a instanceof Uint8Array,u=f?a.length>>2:a?.width,l=f?1:a?.height;"sx"in this||(this.sx=n=u),"sy"in this||(this.sy=o=l),this._coordinates=K(this._cells,n,o,u,l),c=!0}if("ox"in t||"oy"in t)for(let f of e)f._origin=void 0;if("sx"in t||"sy"in t||c)for(let f of e)f._scale=void 0}add(t={}){return t instanceof w||(t=new w(t)),t.asset?.remove?.(t),t.asset=this,Object.assign(t,{_origin:void 0,_scale:void 0}),this.nodes.add(t),t}remove(t){t.asset=void 0,this.nodes.delete(t)}destroy(t){let{geometry:e,nodes:s}=this;e&&e!==t&&e.remove(this);for(let i of s)i.destroy(this)}},v=I;T(v,"defaultProps",{tags:"",cells:"0:0"});function N(...r){return r.reduce((t,e)=>[t[0]+e[0],t[1]+e[1]])}function C(...r){return r.reduce((t,e)=>{let s=[];for(let i=0;i<t.length;i+=2)s.push(t[i]*e[0]+t[i+1]*e[1],t[i]*e[2]+t[i+1]*e[3]);return s})}var J=[[0,0],[1,0],[1,1],[0,1]],j=class{constructor(t){Object.assign(this,j.defaultProps),this.nodes=new Set,t&&this.update(t)}update(t={}){"asset"in t&&(this.asset?.remove?.(this),t.asset.add(this)),"group"in t&&(this.group?.remove?.(this),t.group.add(this));let{oncollide:e,collisions:s}=Object.assign(this,t);if("tags"in t){let{tags:i}=t,n=i.trim();this._tags=n?n.split(/\s+/):[]}"oncollide"in t&&(e?s||(this.collisions=new Set):this.collisions=void 0),this._finalizeUpdate(t)}_finalizeUpdate(t){if(("ox"in t||"oy"in t)&&(this._origin=void 0),("px"in t||"py"in t)&&(this._position=void 0),"az"in t&&(this._rotation=void 0),("sx"in t||"sy"in t)&&(this._scale=void 0),"oxa"in t||"oya"in t||"pxa"in t||"pya"in t||"aza"in t||"sxa"in t||"sya"in t){let{oxa:e,oya:s,pxa:i,pya:n,aza:o,sxa:a,sya:c}=this;this._aActive=!!(e||s||i||n||o||a||c)}if("oxs"in t||"oys"in t||"pxs"in t||"pys"in t||"azs"in t||"sxs"in t||"sys"in t){let{oxs:e,oys:s,pxs:i,pys:n,azs:o,sxs:a,sys:c}=this;this._sActive=!!(e||s||i||n||o||a||c)}}add(t={}){return t instanceof j||(t=new j(t)),t.group?.remove?.(t),t.group=this,this.nodes.add(t),t}remove(t){t.group=void 0,this.nodes.delete(t)}destroy(t){let{group:e,asset:s,nodes:i}=this;e&&e!==t&&e.remove(this),s&&s!==t&&s.remove(this);for(let n of i)n.destroy(this)}find(t,e){let{nodes:s}=this,i=[];if(typeof t=="string"){let n=t.split(",").map(o=>o.trim().split(/\s+/).map(a=>a.split(".")));return this._findFromQueries(n,e)}else{if(typeof t!="function")return i;t(this)&&(i.push(this),e-=1)}for(let n of s){if(e<=0)break;let o=n.find(t,e);i.push(...o),e-=o.length}return i}_findFromQueries(t,e){let s=[],{_tags:i=[],asset:n,nodes:o}=this,a=n?[...n._tags,...i]:i,c=n?.type||"",f=[],u=!1;for(let[l,...x]of t){let[h,...d]=l;h!==c||!d.every(m=>a.some(A=>A===m))||(x.length?f.push(x):u=!0)}u&&(s.push(this),e-=1),f.push(...t);for(let l of o){if(e<=0)break;let x=l._findFromQueries(f,e);s.push(...x),e-=x.length}return s}paint(t={}){t instanceof v||(t=new v(t));let{asset:e}=this;return e&&e.nodes.delete(this),t.add(this),t}_applyPhysics(t,e){let{group:s,_lastPhysicsFrame:i}=this;if(i===e)return;s&&s._applyPhysics(t,e),this._lastPhysicsFrame=e;let{_aActive:n,_sActive:o,oxs:a,oys:c,pxs:f,pys:u,azs:l,sxs:x,sys:h}=this,d={};if(n){let{oxa:p,oya:S,pxa:P,pya:U,aza:R,sxa:z,sya:D}=this;p&&(d.oxs=a+=p*t),S&&(d.oys=c+=S*t),P&&(d.pxs=f+=P*t),U&&(d.pys=u+=U*t),R&&(d.azs=l+=R*t),z&&(d.sxs=x+=z*t),D&&(d.sys=h+=D*t)}else if(!o)return;let{ox:_,oy:m,px:A,py:O,az:E,sx:y,sy:g}=this;a&&(d.ox=_+a*t),c&&(d.oy=m+c*t),f&&(d.px=A+f*t),u&&(d.py=O+u*t),l&&(d.az=E+l*t),x&&(d.sx=y+x*t),h&&(d.sy=g+h*t),this.update(d)}_recalculate(t,e){let{group:s}=this;s&&s._recalculate(t,this);let{asset:i,nodes:n,_composite:o,_position:a,_origin:c,_rotation:f,_scale:u,_inverted:l}=this;if(o&&a&&c&&f&&u)return;if(this._lastCalculatedFrame=t,!f||!u){if(!f){let{az:h}=this,d=Math.cos(h),_=Math.sin(h);this._rotation=[d,-_,_,d]}if(!u){let{sx:h,sy:d}=this;i&&(h*=i.sx||1,d*=i.sy||1),this._scale=l?[1/h,0,0,1/d]:[h,0,0,d]}({_rotation:f,_scale:u}=this),this._matrix=l?C(u,f):C(f,u),c=void 0}let{_matrix:x}=this;if(this._composite=s?C(s._composite,x):x,!a||!o){let{px:h,py:d}=this,_=l?[-h,-d]:[h,d];s&&(_=C(_,s._composite),_=N(_,s._position)),this._position=_}if(!c||!o){let{ox:h,oy:d,_composite:_}=this;i&&(h+=i.ox||0,d+=i.oy||0),this._origin=C(l?[h,d]:[-h,-d],_)}for(let h of n)h._composite=void 0,h!==e&&h._recalculate(t,this)}_recalculateBoundaries(){let{_composite:t,_position:e,_origin:s,_boundaries:i}=this,n=J.map(x=>{let h=C(x,t);return N(h,e,s)}),o=n.map(x=>x[0]),a=n.map(x=>x[1]),c=Math.min(...o),f=Math.max(...o),u=Math.min(...a),l=Math.max(...a);this._boundaries=[c,f,u,l]}},w=j;T(w,"defaultProps",{ox:0,oy:0,px:0,py:0,az:0,sx:1,sy:1,oxs:0,oys:0,oxa:0,oya:0,pxs:0,pys:0,pxa:0,pya:0,azs:0,aza:0,sxs:0,sys:0,sxa:0,sya:0,cell:0});var Z=[0,0,0,1,0,0,1,1,0,1,1,0,0,1,0,0,0,0],V=class{constructor(t={}){this.joints=Object.assign(new v,{geometry:this}),this.assets=new Set,this.update({...V.defaultProps,...t})}update(t={}){Object.assign(this,t),"mesh"in t&&(this._mesh=t.mesh)}add(t={}){if("texture"in t)t instanceof v||(t=new v(t));else{let e=this.joints.add(t);return e._recalculate(0),e}return t.geometry?.remove?.(t),t.geometry=this,this.assets.add(t),t}remove(t){this.assets.delete(t)}destroy(t){let{layer:e,assets:s}=this;e&&e!==t&&e.remove(this);for(let i of s)i.destroy(this)}},L=V;T(L,"defaultProps",{mesh:Z});var k=class{constructor(t={}){this.library=Object.assign(new L,{layer:this}),this.geometries=new Set,this.update({...k.defaultProps,...t})}update(t={}){Object.assign(this,t)}add(t={}){if("mesh"in t)t instanceof L||(t=new L(t));else return this.library.add(t);return t.layer?.remove?.(t),t.layer=this,this.geometries.add(t),t}remove(t){this.geometries.delete(t)}destroy(t){let{scene:e,geometries:s}=this;e&&e!==t&&e.remove(this);for(let i of s)i.destroy(this)}},b=k;T(b,"defaultProps",{parallax:1});var tt=`
	attribute vec3 aVertex;
	attribute vec2 aCoordinate;

	uniform mat2 uMatrix;
	uniform vec2 uPosition;
	uniform vec2 uOrigin;
	uniform float uLayerParallax;
	uniform float uLayerSquash;
	uniform float uLayerDepth;
	uniform mat2 uSceneMatrix;
	uniform vec2 uScenePosition;
	uniform vec2 uSceneOrigin;

	varying vec2 vCoordinate;

	void main() {
		vec2 sceneShift = (uScenePosition + uSceneOrigin) * uLayerParallax;
		vec2 vertex = aVertex.xy * uMatrix + uPosition + uOrigin + sceneShift;
		float depth = aVertex.z * uLayerSquash + uLayerDepth;
		gl_Position = vec4(vertex * uSceneMatrix, -depth, 1.0);
		vCoordinate = aCoordinate;
	}
`,et=`
	precision mediump float;

	uniform sampler2D uImage;

	varying vec2 vCoordinate;

	void main() {
		vec4 pixel = texture2D(uImage, vCoordinate);
		gl_FragColor = pixel;
	}
`;function H(r,t,e){let s=r.createShader(e);return r.shaderSource(s,t),r.compileShader(s),r.getShaderParameter(s,r.COMPILE_STATUS)||(console.log(`Error compiling ${e===r.VERTEX_SHADER?"vertex":"fragment"} shader:`),console.log(r.getShaderInfoLog(s))),s}function G(r){let t=r.createProgram(),e=H(r,tt,r.VERTEX_SHADER);e&&r.attachShader(t,e);let s=H(r,et,r.FRAGMENT_SHADER);return s&&r.attachShader(t,s),r.linkProgram(t),r.getProgramParameter(t,r.LINK_STATUS)||(console.log("Error linking shader program:"),console.log(r.getProgramInfoLog(t))),t}function q(r,t,e,s,i){let{ARRAY_BUFFER:n,STATIC_DRAW:o,FLOAT:a}=r;r.bindBuffer(n,e),r.enableVertexAttribArray(t),r.bufferData(n,new Float32Array(i),o),r.vertexAttribPointer(t,s,a,!1,0,0)}function Q(r,t,e,s){let i=[];for(let n of r){let{_lastCalculatedFrame:o,_boundaries:a}=n;if(o!==e){i.push(n);continue}for(let c of t){if(c===n)continue;let{_boundaries:f}=n,{_boundaries:u}=c,l=[u[1]-f[0],f[1]-u[0],u[3]-f[2],f[3]-u[2]],x=l.every(y=>y>=0);if(s){let[y,g,p,S]=l;l=[g,y,S,p];let P=n;n=c,c=P}let{collisions:h,oncollide:d}=n;if(x===h.has(c))continue;let _=Math.min(...l),m=l.indexOf(_),{param:A}=c,E=d({overlap:l,side:m,param:A,action:x?"collide":"separate",self:n,node:c});if(E){let y=m%2?-1:1,g={...E};m<2&&!("px"in g)?g.px=n.px+l[m]*y:m>1&&!("py"in g)&&(g.py=n.py+l[m]*y),n.update(g)}else x?h.add(c):h.delete(c)}}return i}var M=class extends w{constructor(t){super(),this.ui=Object.assign(new b,{scene:this}),this.layers=[],this._inverted=!0,t&&this.update(t)}update(t={}){if(Object.assign(this,t),this._finalizeUpdate(t),!("gl"in this)){let{density:e=2,canvas:s,width:i,height:n}=this;if(!s){let{width:c=640,height:f=360}=t;s=document.createElement("canvas"),document.body.appendChild(s),Object.assign(s,{width:Math.round(c*e),height:Math.round(f*e)}),Object.assign(s.style,{position:"absolute",left:"50vw",top:"0",width:`${c/f*100}vh`,height:"100vh",transform:"translateX(-50%)"})}i===void 0&&(i=s.width/e),n===void 0&&(n=s.height/e),this.asset={ox:0,oy:0,sx:i/2,sy:n/2};let o=s.getContext("webgl"),a=G(o);o.clearColor(.5,.5,.5,.5),o.useProgram(a),this.gl=o,this.aVertex=o.getAttribLocation(a,"aVertex"),this.aCoordinate=o.getAttribLocation(a,"aCoordinate"),this.uMatrix=o.getUniformLocation(a,"uMatrix"),this.uPosition=o.getUniformLocation(a,"uPosition"),this.uOrigin=o.getUniformLocation(a,"uOrigin"),this.uLayerParallax=o.getUniformLocation(a,"uLayerParallax"),this.uLayerSquash=o.getUniformLocation(a,"uLayerSquash"),this.uLayerDepth=o.getUniformLocation(a,"uLayerDepth"),this.uSceneMatrix=o.getUniformLocation(a,"uSceneMatrix"),this.uScenePosition=o.getUniformLocation(a,"uScenePosition"),this.uSceneOrigin=o.getUniformLocation(a,"uSceneOrigin"),o.enable(o.DEPTH_TEST),o.blendEquation(o.FUNC_ADD),o.blendFunc(o.SRC_ALPHA,o.ONE_MINUS_SRC_ALPHA),this._frameCount=0,setTimeout(()=>this._animate(),0),document.addEventListener("visibilitychange",()=>{document.hidden?this.pause():this.resume()})}}add(t={}){if("parallax"in t)t instanceof b||(t=new b(t));else return this.ui.add(t);let{layers:e}=this;return e.indexOf(t)===-1&&(t.scene?.remove?.(t),e.push(t)),t.scene=this,e.sort((s,i)=>s.parallax-i.parallax),t}remove(t){let{layers:e}=this,s=e.indexOf(t);s!==-1&&e.splice(s,1)}destroy(){for(let t of this.layers)t.destroy(this)}_renderGeometry(t){let{gl:e,aVertex:s,aCoordinate:i,uMatrix:n,uPosition:o,uOrigin:a}=this,{TEXTURE_2D:c,CLAMP_TO_EDGE:f,RGBA:u,TRIANGLES:l}=e;"_glBuffer"in t||(t._glBuffer=e.createBuffer());let{mesh:x,assets:h,_glBuffer:d}=t;q(e,s,d,3,x);for(let _ of h){"_glTexture"in _||(_._glTexture=e.createTexture()),"_glBuffer"in _||(_._glBuffer=e.createBuffer());let{_texture:m,_coordinates:A,width:O,height:E,nodes:y,_glTexture:g,_glBuffer:p}=_;if(m===void 0)continue;let S=[];e.activeTexture(e.TEXTURE0),e.bindTexture(c,g),m instanceof Uint8Array?S=[O,E,0]:(e.texParameteri(c,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(c,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(c,e.TEXTURE_WRAP_S,f),e.texParameteri(c,e.TEXTURE_WRAP_T,f)),e.texImage2D(c,0,u,...S,u,e.UNSIGNED_BYTE,m);for(let P of y){let{cell:U,_position:R,_origin:z,_composite:D}=P;q(e,i,p,2,A[U]),e.uniformMatrix2fv(n,!1,D),e.uniform2fv(o,R),e.uniform2fv(a,z),e.drawArrays(l,0,6)}}}render(t){let{gl:e,ui:s,layers:i,_frameCount:n}=this,o=[...i,s],a=o.map(({library:y,geometries:g})=>{let p=[...y.joints.nodes];for(let{assets:S}of[y,...g])for(let{nodes:P}of S)p.push(...P);return p});this._applyPhysics(t,n);for(let y of a)for(let g of y)g._applyPhysics(t,n);this.ondraw&&this.ondraw(t,n);for(let y of a){let g=[],p=[];for(let P of y){let{param:U,oncollide:R}=P;!R&&U===void 0||(R&&g.push(P),U!==void 0&&p.push(P),P._recalculate(n),P._recalculateBoundaries(n))}let S=Q(g,p,n);Q(p,S,n,!0)}this._recalculate(n);for(let y of a)for(let g of y)g._recalculate(n);let{uSceneMatrix:c,uScenePosition:f,uSceneOrigin:u,uLayerParallax:l,uLayerSquash:x,uLayerDepth:h,_matrix:d,_position:_,_origin:m,_scale:A}=this;e.clear(e.COLOR_BUFFER_BIT),e.uniformMatrix2fv(c,!1,d),e.uniform2fv(f,_),e.uniform2fv(u,m);let O=2/o.length;e.uniform1f(x,O),e.depthMask(!0),e.disable(e.BLEND);let E=1-O/2;for(let y=o.length-1;y>=0;y--){let{parallax:g,geometries:p}=o[y];e.uniform1f(l,g),e.uniform1f(h,E),E-=O;for(let S of p)this._renderGeometry(S)}e.depthMask(!1),e.enable(e.BLEND),E=-1+O/2;for(let y of o){let{parallax:g,library:p}=y;y===s&&e.uniformMatrix2fv(c,!1,A),e.uniform1f(l,g),e.uniform1f(h,E),E+=O,this._renderGeometry(p)}this._frameCount++}_animate(t=0){this.render(t),requestAnimationFrame(e=>{if(this._paused)return;let{_previousTime:s=e}=this;this._previousTime=e;let i=(s&&e-s)/1e3;this._animate(i)})}resume(){this._paused&&(this._paused=!1,this._animate())}pause(){this._paused||(this._paused=!0,this._previousTime=void 0)}};T(M,"defaultProps",{});var F=new Set,X={};window.addEventListener("keydown",({key:r,repeat:t})=>{if(t)return;let e=X[r];e&&(F.add(e),e.activate())});window.addEventListener("keyup",({key:r})=>{let t=X[r];t&&(F.delete(t),t.deactivate())});var B=class{constructor(t,e,s){let{key:i}=t;i&&(X[i]=this),this.ondown=e,this.onup=s}activate(){this.ondown()}deactivate(){this.onup&&this.onup()}};var st={scene:M.defaultProps,layer:b.defaultProps,geometry:L.defaultProps,asset:v.defaultProps,node:w.defaultProps},it={createTextNode(){},createElement(r){r=r.toLowerCase();let t=new{scene:M,layer:b,geometry:L,asset:v,node:w}[r];return Object.assign(t,{tagName:r,childNodes:[],appendChild:e=>t.add(e),insertBefore:e=>t.add(e),removeChild:e=>e.destroy()})}};function nt(r,t,e){if(e){let{tagName:s}=r;e=new Set(e);let i=Object.entries(t).filter(([n,o])=>(e.delete(n),o!==r[n]&&(n.length>3||o!==void 0)));for(let n of e)i.push([n,st[s][n]]);if(!i.length)return;t=Object.fromEntries(i)}else{let s=t.id;s&&(!Object.prototype.hasOwnProperty.call(window,s)||window[s]._instance===r)&&(window[s]=r)}r.update(t)}var Bt=0,jt=1,zt=2,Dt=3;function ot(...r){let[t={}]=r;return"key"in t?new B(...r):new M(...r)}window.spective=Object.assign(ot,{Scene:M,Layer:b,Geometry:L,Asset:v,Node:w,Control:B,controls:F,framework:[it,nt],LEFT:0,RIGHT:1,BOTTOM:2,TOP:3});})();
