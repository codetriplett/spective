/*! spective 2019-02-25 */

!function(){"use strict";var o=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],r=!0,i=!1,a=void 0;try{for(var o,s=t[Symbol.iterator]();!(r=(o=s.next()).done)&&(n.push(o.value),!e||n.length!==e);r=!0);}catch(t){i=!0,a=t}finally{try{!r&&s.return&&s.return()}finally{if(i)throw a}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},e=function(){function r(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(t,e,n){return e&&r(t.prototype,e),n&&r(t,n),t}}(),a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},s=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t};function T(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}function c(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function u(){for(var e=[],n=[],t=arguments.length,r=Array(t),i=0;i<t;i++)r[i]=arguments[i];return r.forEach(function(t){"object"===(void 0===t?"undefined":a(t))?(n=[function(t){var i=s({},t),e=i.scale;"number"==typeof e&&(i.scale=Array(3).fill(e));var n={};return["scale","offset","angle","position"].forEach(function(r){var t=i[r];Array.isArray(t)&&t.forEach(function(t,e){var n=""+r+"XYZ"[e];"number"!=typeof i[n]&&(i[n]=t)})}),["scaleX","scaleY","scaleZ","offsetX","offsetY","offsetZ","angleX","angleY","angleZ","positionX","positionY","positionZ"].forEach(function(t){var e=i[t];"number"==typeof e&&(n[t]=e)}),n}(t)],e.push(n)):n.push(t)}),e}var n=function(){function t(){c(this,t)}return e(t,[{key:"activate",value:function(){arguments.length&&(this.timestamp=Date.now(),this.queue=u.apply(void 0,arguments));var t=this.queue,e=!t.length,n=t.shift()||[],r=o(n,2),i=r[0],a=r[1];if(this.changes=i,this.iterator=a,this.duration=void 0,e)return this.timestamp=void 0,this.existing=void 0,this.looping=void 0,void(this.iteration=void 0);this.looping="function"==typeof a,this.iteration=-1,this.iterate(),arguments.length&&this.animate(this.timestamp)}},{key:"iterate",value:function(){this.existing=s({},this.properties),this.iteration++;var t=this.looping,e=this.iterator,n=this.iteration,r=this.duration;0<(r=t?e(n):n?0:e)?this.duration=r:(0===n&&this.interpolate(1),this.activate())}},{key:"interpolate",value:function(t){var e=this.existing,n=this.changes,r=this.properties,i=1-(this.looping?0:t);for(var a in n){var o=e[a]||0,s=n[a]*t;r[a]=o*i+s}}},{key:"animate",value:function(t){for(var e=this.timestamp,n=this.properties,r=this.duration,i=t-e;r<=i;)this.interpolate(1),this.timestamp+=r,i-=r,this.iterate(),r=this.duration;if(0<r){var a=i/r;this.interpolate(a)}this.calculate(n)}}]),t}(),g=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];function l(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},s=arguments[1],c=arguments[2],e=t.positionX,n=t.positionY,r=t.positionZ,i=t.angleX,a=t.angleY,o=t.angleZ,u=t.offsetX,f=t.offsetY,l=t.offsetZ,h=t.scaleX,v=t.scaleY,p=t.scaleZ,d=[[e,n,r].some(function(t){return void 0!==t})?[e,n,r]:void 0,o,i,a,[u,f,l].some(function(t){return void 0!==t})?[u,f,l]:void 0,[h,v,p].some(function(t){return void 0!==t})?[h,v,p]:void 0].map(function(t,e){var n=g.slice();if(void 0!==t){if(0<e&&e<4){var r=Math.cos(t),i=Math.sin(s?-t:t),a=5*(e-1),o=3===e?-2:1;[r,i,-i,r].forEach(function(t,e){n[a+(2<=e?o<<2:0)+e%2*o]=t})}else{if(s&&c)return;5===e?t.forEach(function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1,e=arguments[1];n[5*e]=s?1/(t||1):t}):t.forEach(function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0,e=arguments[1];n[12+e]=s?-t:t})}return n}});if(s&&!c){var m,y=d.splice(1,3);(m=d.reverse()).splice.apply(m,[2,0].concat(T(y)))}return d.filter(function(t){return t})}function h(t){return t.reduce(function(t,e){if(!e)return t;for(var n=[],r=0;r<4;r++)for(var i=0;i<4;i++){for(var a=4*r,o=0,s=0;s<4;s++)o+=e[a+s]*t[4*s+i];n[a+i]=o}return n})}var d=function(t){function a(t){for(var e=arguments.length,n=Array(1<e?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];c(this,a);var i=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(a.__proto__||Object.getPrototypeOf(a)).call(this));return!0===t?i.inverted=!0:t instanceof a&&(t.children||(t.children=[]),t.children.push(i),i.anchor=t),i.properties={scaleX:1,scaleY:1,scaleZ:1},i.animations=[],n.length||(n=[{}]),i.activate.apply(i,T(n)),i}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(a,n),e(a,[{key:"calculate",value:function(t){var e=this.inverted,n=this.anchor,r=this.children,i=void 0===r?[]:r,a=void 0,o=void 0;if(t&&(a=l(t,e),o=l(t,!e,e),this.relativeMatrix=h(a),this.relativeInverse=h(o)),n){var s=n.relativeMatrix,c=n.relativeInverse,u=n.absoluteMatrix||s,f=n.absoluteInverse||c;this.absoluteMatrix=h([u,this.relativeMatrix]),this.absoluteInverse=h([f,this.relativeInverse])}i.forEach(function(t){return t.calculate()})}}]),a}(),f="0123456789abcdef";var v=/^(#[0-9a-f]{3}|#[0-9a-f]{6})$/,r=function(){function s(t){var n,r,e,i=this,a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:function(){};if(c(this,s),v.test(t))this.image=(r=4<(n=t).length?1:0,e=[0,1,2].map(function(t){var e=1+(t<<r);return(f.indexOf(n[e])<<4)+f.indexOf(n[e+r])}),new Uint8Array([].concat(T(e),[255])));else{var o=new window.Image;o.src=t,o.addEventListener("load",function(){i.image=function(t){var e=t.width,n=t.height,r=b(e),i=b(n);if(r===e&&i===n)return t;var a=document.createElement("canvas"),o=a.getContext("2d");return a.width=r,a.height=i,o.drawImage(t,0,0,r,i),o.getImageData(0,0,r,i)}(o),a(t)}),o.addEventListener("error",function(){return a(t)})}this.instances=[]}return e(s,[{key:"createInstance",value:function(){for(var t=arguments.length,e=Array(t),n=0;n<t;n++)e[n]=arguments[n];var r=new(Function.prototype.bind.apply(d,[null].concat(e)));return this.instances.push(r),r}},{key:"destroyInstance",value:function(t,e){if(e){for(var n=t.anchor;n&&n!==e;)n=n.anchor;if(!n)return}var r=this.instances;r.splice(r.indexOf(t),1)}}]),s}();function I(t,e,n,r,i,a){return(t*(r-a)+n*(a-e)+i*(e-r))/2}function M(t){var e=Math.max.apply(Math,T(t.map(function(t){return Math.abs(t)})));return 0===e?t:t.map(function(t){return t/e})}function _(t){for(var e=t.length/3,n=[0,0,0],r=0;r<t.length;r+=3)n[0]+=t[r],n[1]+=t[r+1],n[2]+=t[r+2];return M(n.map(function(t){return t/e}))}function p(t,e,n){var r=t.match(new RegExp("(^|\n)"+e+" [^\n]+","g"));if(r)return r.map(function(t){return t.split(/ +/).slice(1).map(function(t){return n?t.split("/").map(function(t){return 0<t?t-1:Number(t)}):Number(t)})})}function m(t,n,r){var e;return(e=[]).concat.apply(e,T(t.map(function(t){var e=t[n];return r?r[e+(e<0?r.length:0)]:e})))}function y(t){var o=p(t,"v");if(o){var e,s=p(t,"vt"),c=p(t,"vn"),n=p(t,"f",!0),u=[],f=[],l=[],h=[];if(n.forEach(function(t){for(var e=t.length-1,n=1;n<e;n++){var r,i,a=[t[0],t[n],t[n+1]];if(u.push.apply(u,T(m(a,0))),f.push.apply(f,T(m(a,0,o))),s)(r=l).push.apply(r,T(m(a,1,s)));if(c)(i=h).push.apply(i,T(m(a,2,c)))}}),s||(l=f.filter(function(t,e){return e%3!=1}).map(function(t,e){return e%2==1?-t:t})),!c)h=function(t,e){for(var n,r,i,a=t.map(function(t){return t<0?e.length+t:t}),o=Math.max.apply(Math,T(a))+1,s=[],c=[],u=0;u<o;u++)c[u]=[];for(var f=0;f<a.length;f+=3){var l=a[f],h=a[f+1],v=a[f+2],p=3*l,d=3*h,m=3*v,y=e.slice(p,p+3),g=e.slice(d,d+3),b=e.slice(m,m+3),A=(r=g,i=b,M([I((n=y)[1],n[2],r[1],r[2],i[1],i[2]),I(n[2],n[0],r[2],r[0],i[2],i[0]),I(n[0],n[1],r[0],r[1],i[0],i[1])]));c[l]=c[l].concat(A),c[h]=c[h].concat(A),c[v]=c[v].concat(A)}c=c.map(_);for(var E=0;E<a.length;E+=3){var x=c[a[E]],w=c[a[E+1]],L=c[a[E+2]];s.push.apply(s,T(x).concat(T(w),T(L)))}return s}(u,(e=[]).concat.apply(e,T(o)));var r=Math.min.apply(Math,T(l)),i=Math.max.apply(Math,T(l));return{vertices:new Float32Array(f),coordinates:new Float32Array(l),normals:new Float32Array(h),repeatTexture:r<0||1<i}}}function b(t){return Math.pow(2,Math.ceil(Math.log2(t)))}var i=function(){function t(e){var n=this,r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:function(){};c(this,t);var i=new XMLHttpRequest;i.onload=function(){var t=i.status;200!==t&&404!==t||(200===t&&Object.assign(n,y(i.responseText)),r(e))},i.open("GET",e),i.send(),this.assets={}}return e(t,[{key:"createAsset",value:function(t,e){var n=this.assets[t];return n||(n=new r(t,e),this.assets[t]=n),n}},{key:"destroyAsset",value:function(t,e){if(e){var n=this.assets[t];n.instances.forEach(function(t){return n.destroyInstance(t,e)})}else delete this.assets[t]}}]),t}(),A=function(){function o(t,e){c(this,o);var n=t.getContext("webgl"),r=n.createProgram(),i=n.createShader(n.VERTEX_SHADER),a=n.createShader(n.FRAGMENT_SHADER);n.shaderSource(i,"\n\tuniform mat4 uInstance;\n\tuniform mat4 uInverse;\n\tuniform mat4 uScene;\n\tuniform mat4 uPerspective;\n\n\tattribute vec3 aVertex;\n\tattribute vec3 aNormal;\n\tattribute vec2 aCoordinate;\n\n\tvarying vec3 vNormal;\n\tvarying vec3 vDirection;\n\tvarying vec2 vCoordinate;\n\n\tvoid main() {\n\t\tgl_Position = uPerspective * uScene * uInstance * vec4(aVertex, 1);\n\t\tvNormal = aNormal;\n\t\tvDirection = normalize(uInverse * vec4(1, 1, 1, 1)).xyz;\n\t\tvCoordinate = aCoordinate;\n\t}\n"),n.shaderSource(a,"\n\tprecision mediump float;\n\n\tuniform sampler2D uImage;\n\n\tvarying vec3 vNormal;\n\tvarying vec3 vDirection;\n\tvarying vec2 vCoordinate;\n\n\tvoid main() {\n\t\tfloat intensity = 0.5 + 0.5 * (dot(vDirection, vNormal) + 0.7) / 1.7;\n\t\tvec3 color = texture2D(uImage, vCoordinate).xyz * intensity;\n\t\tgl_FragColor = vec4(color, 1);\n\t}\n"),n.compileShader(i),n.compileShader(a),n.attachShader(r,i),n.attachShader(r,a),n.linkProgram(r),n.useProgram(r),n.enable(n.DEPTH_TEST),n.depthFunc(n.LESS),n.enable(n.CULL_FACE),n.cullFace(n.BACK),n.clearColor(0,0,0,1),this.setAttribute=this.setAttribute.bind(this),this.setSampler=this.setSampler.bind(this),this.resize=this.resize.bind(this),this.toggle=this.toggle.bind(this),this.render=this.render.bind(this),this.createGeometry=this.createGeometry.bind(this),this.destroyGeometry=this.destroyGeometry.bind(this),this.canvas=t,this.gl=n,this.camera=e,this.geometries={},this.instanceLocation=n.getUniformLocation(r,"uInstance"),this.inverseLocation=n.getUniformLocation(r,"uInverse"),this.sceneLocation=n.getUniformLocation(r,"uScene"),this.perspectiveLocation=n.getUniformLocation(r,"uPerspective"),this.imageLocation=n.getUniformLocation(r,"uImage"),this.vertexLocation=n.getAttribLocation(r,"aVertex"),this.normalLocation=n.getAttribLocation(r,"aNormal"),this.coordinateLocation=n.getAttribLocation(r,"aCoordinate")}return e(o,[{key:"setAttribute",value:function(t,e,n,r){var i=this.gl,a=i.ARRAY_BUFFER;return r=r||i.createBuffer(),i.bindBuffer(a,r),i.enableVertexAttribArray(t),i.bufferData(a,e,i.STATIC_DRAW),i.vertexAttribPointer(t,n,i.FLOAT,!1,0,0),r}},{key:"setSampler",value:function(t,e,n,r,i){var a=this.gl,o=a.TEXTURE_2D,s=a.RGBA,c=a.CLAMP_TO_EDGE,u=r instanceof Uint8Array,f=u?[r.length/4,1,0]:[];return i=i||a.createTexture(),a.activeTexture(a["TEXTURE"+e]),a.bindTexture(o,i),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0),a.texImage2D.apply(a,[o,0,s].concat(f,[s,a.UNSIGNED_BYTE,r])),u||(a.generateMipmap(o),a.texParameteri(o,a.TEXTURE_MIN_FILTER,a.LINEAR_MIPMAP_LINEAR)),n||(a.texParameteri(o,a.TEXTURE_WRAP_S,c),a.texParameteri(o,a.TEXTURE_WRAP_T,c)),a.uniform1i(t,e),i}},{key:"resize",value:function(){var t=this.render,e=this.canvas,n=this.gl,r=this.perspectiveLocation,i=e.clientWidth,a=e.clientHeight,o=Math.max(i,a);e.width=i,e.height=a,n.viewport(0,0,i,a),n.uniformMatrix4fv(r,!1,[o/i,0,0,0,0,o/a,0,0,0,0,-1,-1,0,0,-2,0]),t()}},{key:"toggle",value:function(){this.locked=!this.locked,this.locked||this.resize()}},{key:"render",value:function(t){if(this.locked)this.resolved=void 0;else{var e=this.render,f=this.setAttribute,l=this.setSampler,h=this.gl,n=this.camera,r=this.geometries,i=this.resolved,a=this.sceneLocation,v=this.vertexLocation,p=this.normalLocation,d=this.coordinateLocation,m=this.imageLocation,y=this.instanceLocation,g=this.inverseLocation;if(void 0===i||void 0!==t&&!i){h.clear(h.COLOR_BUFFER_BIT),h.clear(h.DEPTH_BUFFER_BIT);var b=Date.now(),A=!0;n.timestamp&&(n.animate(b),A=A&&!n.timestamp),h.uniformMatrix4fv(a,!1,n.relativeMatrix),Object.values(r).forEach(function(t){var e=t.vertices,n=t.normals,r=t.coordinates,i=t.repeatTexture,a=t.assets,o=t.vertexBuffer,s=t.normalBuffer,c=t.coordinateBuffer;if(e){var u=e.length/3;t.vertexBuffer=f(v,e,3,o),t.normalBuffer=f(p,n,3,s),t.coordinateBuffer=f(d,r,2,c),Object.values(a).forEach(function(t){var e=t.image,n=t.instances,r=t.imageTexture;e&&(t.imageTexture=l(m,0,i,e,r),n.forEach(function(t){t.timestamp&&(t.animate(b),A=A&&!t.timestamp);var e=t.absoluteMatrix,n=t.absoluteInverse,r=t.relativeMatrix,i=t.relativeInverse;h.uniformMatrix4fv(y,!1,e||r),h.uniformMatrix4fv(g,!1,n||i),h.drawArrays(h.TRIANGLES,0,u)}))})}}),this.resolved=A,window.requestAnimationFrame(e)}else this.resolved=void 0!==t&&void 0}}},{key:"createGeometry",value:function(t,e){var n=this.geometries[t];return n||(n=new i(t,e),this.geometries[t]=n),n}},{key:"destroyGeometry",value:function(t,e){if(e){var n=this.geometries[t],r=n.assets;for(var i in r)n.destroyAsset(i,e)}else delete this.geometries[t]}}]),o}();var t=function(){for(var t=arguments.length,e=Array(t),n=0;n<t;n++)e[n]=arguments[n];var r,i,a,o=e[0],s=!o||"function"!=typeof o.getContext;s?(r=document.createElement("canvas"),i=document.body,(a=document.createElement("style")).innerHTML="\n\t\tbody { margin: 0; }\n\t\tcanvas {\n\t\t\tdisplay: block;\n\t\t\twidth: 100vw;\n\t\t\theight: 100vh;\n\t\t\tposition: absolute;\n\t\t\tleft: 0;\n\t\t\ttop: 0;\n\t\t}\n\t",i.appendChild(a),i.appendChild(r),o=r):e.shift();var c=new(Function.prototype.bind.apply(d,[null].concat([!0],e))),u=new A(o,c),f=u.resize,l=u.toggle,h=u.render,v=u.createGeometry,p=u.destroyGeometry;return f(),s&&window.addEventListener("resize",f),function(){for(var t=arguments.length,e=Array(t),n=0;n<t;n++)e[n]=arguments[n];if(0===e.length)l();else{if("string"==typeof e[0])return function r(t){for(var e=arguments.length,n=Array(1<e?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];var a=n.shift(),o=void 0;if("string"==typeof n[0])o=n.shift();else{if(!n.length)return void p(a,t);o="#fff"}var s=v(a,h);if(!n.length)return s.destroyAsset(o,t),void(Object.keys(s.assets).length||p(a,t));var c=s.createAsset(o,h),u=c.createInstance.apply(c,[t].concat(n));return h(),function(){for(var t=arguments.length,e=Array(t),n=0;n<t;n++)e[n]=arguments[n];if(e.length){if("string"==typeof e[0])return r.apply(void 0,[u].concat(e));u.activate.apply(u,e),h()}else c.destroyInstance(u),c.instances.length||(s.destroyAsset(o),Object.keys(s.assets).length||p(a))}}.apply(void 0,[!1].concat(e));c.activate.apply(c,e),h()}}};window.spective=t,"function"==typeof define&&define.amd&&define("spective",function(){return t})}();